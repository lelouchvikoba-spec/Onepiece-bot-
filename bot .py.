import os
import sqlite3
import telebot
from flask import Flask
from threading import Thread
from datetime import datetime

# Environment variables
BOT_TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = int(os.getenv("OWNER_ID"))

bot = telebot.TeleBot(BOT_TOKEN)

# ---------- SQLite Setup ----------
conn = sqlite3.connect("bot.db", check_same_thread=False)
cursor = conn.cursor()

# Users table
cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY,
    username TEXT,
    bounty INTEGER DEFAULT 0,
    save_bounty INTEGER DEFAULT 0,
    xp INTEGER DEFAULT 0,
    level_points INTEGER DEFAULT 0
)
""")

# Characters table
cursor.execute("""
CREATE TABLE IF NOT EXISTS characters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT,
    anime TEXT,
    rarity TEXT,
    owner_id INTEGER
)
""")
conn.commit()

# ---------- Web Server to keep alive ----------
app = Flask('')

@app.route('/')
def home():
    return "Bot is running!"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

keep_alive()

# ---------- Helper Functions ----------
def add_user(user_id, username):
    cursor.execute("INSERT OR IGNORE INTO users (id, username) VALUES (?, ?)", (user_id, username))
    conn.commit()

def get_user(user_id):
    cursor.execute("SELECT * FROM users WHERE id=?", (user_id,))
    return cursor.fetchone()

# ---------- Commands ----------
@bot.message_handler(commands=['start'])
def start(message):
    add_user(message.from_user.id, message.from_user.username)
    bot.send_message(message.chat.id, "Welcome to One Piece RPG Bot!\nUse /help to see all commands.")

@bot.message_handler(commands=['help'])
def help_cmd(message):
    help_text = """
Available Commands:
/start - Start the bot
/help - Show this message
/info - Show your profile
/bal - Show your bounty
/fruits - Show your fruits
/catch - Guess a character
/harem - Show owned characters
/daily - Claim daily bounty
/weekly - Claim weekly bounty
/claim - Claim join reward
"""
    bot.send_message(message.chat.id, help_text)

@bot.message_handler(commands=['info'])
def info(message):
    user = get_user(message.from_user.id)
    if user:
        text = f"Username: {user[1]}\nBounty: {user[2]}\nSaved: {user[3]}\nXP: {user[4]}\nLevel Points: {user[5]}"
        bot.send_message(message.chat.id, text)
    else:
        bot.send_message(message.chat.id, "You are not registered yet. Use /start.")

@bot.message_handler(commands=['bal'])
def bal(message):
    user = get_user(message.from_user.id)
    if user:
        bot.send_message(message.chat.id, f"Your bounty: {user[2]}")
    else:
        bot.send_message(message.chat.id, "You are not registered yet. Use /start.")

# ---------- Bot Polling ----------
bot.infinity_polling()

from flask import Flask
from threading import Thread

app = Flask('')

@app.route('/')
def home():
    return "Bot is running!"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

keep_alive()
